# ë„¤í‹° ì¸ ì•¡ì…˜

```
2024.04.10
ê°œì¸ êµ¬ë§¤ ë„ì„œ
```

## 02 ì²«ë²ˆì§¸ ë„¤í‹° ì• í”Œë¦¬ì¼€ì´ì…˜


### 2.1 ê°œë°œí™˜ê²½ ì„¤ì •

```
JDK, maven í•„ìš”í•˜ë‹¤.
ë„¤í‹°ì˜ ì œí•œëœ ê¸°ëŠ¥ì€ Java 1.6 ìœ¼ë¡œ ì‹¤í–‰ë˜ì§€ë§Œ, ê¸°íƒ€ ì»´íŒŒì¼ì´ë‚˜ ë©”ì´ë¸ ì‹¤í–‰ì„ ìœ„í•´ 1.7 ì´ìƒ í•„ìš”í•˜ë‹¤.
ì±…ì—ì„œëŠ” 1.8 ë¡œ ì„¤ëª…í•œë‹¤.
```

```
ì´í´ë¦½ìŠ¤ ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰
STS ê°€ ì´í´ë¦½ìŠ¤ ê¸°ë°˜ì´ë¯€ë¡œ, STS ë¡œ í•œë‹¤.

ì›Œí¬ìŠ¤í˜ì´ìŠ¤ : C:\WORKS\WORKS_STS4_GITHUB\WORKS_NETTY_IN_ACTION
```


##### STS ë²„ì „(lombok ì¶”ê°€ ì„¤ì¹˜í•¨)
```
Spring Tool Suite 4 
Version: 4.22.0.RELEASE
...
Lombok v1.18.30 "Envious Ferret" is installed. https://projectlombok.org/
```


##### ë©”ì´ë¸
```
STS ì˜ ë©”ì´ë¸ì„ ì‚¬ìš©í•œë‹¤.
```


##### Java ë²„ì „ ê²€í† 
```
openjdk ì‚¬ì´íŠ¸ì˜ JDK ëŠ” ì°¸ì¡° êµ¬í˜„ì²´ì´ê³ , ë‹¤ìŒ ë²„ì „ ë‚˜ì˜¤ë©´ ì§€ì› ì¢…ë£Œë‹¤.
https://openjdk.org/projects/jdk/17/
https://jdk.java.net/archive/

openjdk ë²¤ë”ì‚¬ëŠ” ì—¬ëŸ¬ê³³ì´ ìˆìœ¼ë‚˜, redhat ê²ƒìœ¼ë¡œ í•œë‹¤.
íšŒì›ê°€ì… í•´ì•¼ í•œë‹¤.
```

##### redhat openjdk
```
https://developers.redhat.com/products/openjdk/download'

ë ˆë“œí–‡ íšŒì›ê°€ì… í•´ì•¼í•˜ê³ , ë¡œê·¸ì¸ í•´ì•¼ ë°›ì„ ìˆ˜ ìˆë‹¤.


jdk-17.0.10-x64 ZIP

OpenJDK 17 Windows 64-bit
 Release date
January 17, 2024
```


```
C:\Users\colaman>java -version
openjdk version "17.0.10" 2024-01-16 LTS
OpenJDK Runtime Environment (Red_Hat-17.0.10.0+7-2) (build 17.0.10+7-LTS)
OpenJDK 64-Bit Server VM (Red_Hat-17.0.10.0+7-2) (build 17.0.10+7-LTS, mixed mode, sharing)

C:\Users\colaman>
```

```
C:\Users\colaman>java -XshowSettings:properties -version
Property settings:
    file.encoding = MS949
    file.separator = \
    java.class.path =
    java.class.version = 61.0
    java.home = C:\WORKS\WORKS_JAVA_COMMON\JDK\openjdk_redhat\java-17-openjdk-17.0.10.0.7-2.win.x86_64
    java.io.tmpdir = C:\Users\colaman\AppData\Local\Temp\
    java.library.path = C:\WORKS\WORKS_JAVA_COMMON\JDK\openjdk_redhat\java-17-openjdk-17.0.10.0.7-2.win.x86_64\bin
        C:\WINDOWS\Sun\Java\bin
        C:\WINDOWS\system32
        C:\WINDOWS
        C:\WORKS\WORKS_JAVA_COMMON\JDK\openjdk_redhat\java-17-openjdk-17.0.10.0.7-2.win.x86_64\bin
        C:\WORKS\WORKS_JAVA_COMMON\UTIL\MAVEN\apache-maven-3.9.1-bin\apache-maven-3.9.1\bin
        C:\Program Files\Common Files\Oracle\Java\javapath
        C:\WINDOWS\system32
        C:\WINDOWS
        C:\WINDOWS\System32\Wbem
        C:\WINDOWS\System32\WindowsPowerShell\v1.0\
        C:\WINDOWS\System32\OpenSSH\
        C:\Program Files\Bandizip\
        C:\Program Files\TortoiseGit\bin
        C:\Program Files\Git\cmd
        C:\Users\colaman\AppData\Local\Microsoft\WindowsApps

        C:\WORKS\WORKS_INTELLIJ\JetBrains\IntelliJ IDEA 2023.1\bin

        .
    java.runtime.name = OpenJDK Runtime Environment
    java.runtime.version = 17.0.10+7-LTS
    java.specification.name = Java Platform API Specification
    java.specification.vendor = Oracle Corporation
    java.specification.version = 17
    java.vendor = Red Hat, Inc.
    java.vendor.url = https://access.redhat.com/
    java.vendor.url.bug = https://bugzilla.redhat.com/enter_bug.cgi
    java.vendor.version = (Red_Hat-17.0.10.0+7-2)
    java.version = 17.0.10
    java.version.date = 2024-01-16
    java.vm.compressedOopsMode = Zero based
    java.vm.info = mixed mode, sharing
    java.vm.name = OpenJDK 64-Bit Server VM
    java.vm.specification.name = Java Virtual Machine Specification
    java.vm.specification.vendor = Oracle Corporation
    java.vm.specification.version = 17
    java.vm.vendor = Red Hat, Inc.
    java.vm.version = 17.0.10+7-LTS
    jdk.debug = release
    line.separator = \r \n
    native.encoding = MS949
    os.arch = amd64
    os.name = Windows 11
    os.version = 10.0
    path.separator = ;
    sun.arch.data.model = 64
    sun.boot.library.path = C:\WORKS\WORKS_JAVA_COMMON\JDK\openjdk_redhat\java-17-openjdk-17.0.10.0.7-2.win.x86_64\bin
    sun.cpu.endian = little
    sun.cpu.isalist = amd64
    sun.io.unicode.encoding = UnicodeLittle
    sun.java.launcher = SUN_STANDARD
    sun.jnu.encoding = MS949
    sun.management.compiler = HotSpot 64-Bit Tiered Compilers
    sun.os.patch.level =
    sun.stderr.encoding = ms949
    sun.stdout.encoding = ms949
    user.country = KR
    user.dir = C:\Users\colaman
    user.home = C:\Users\colaman
    user.language = ko
    user.name = colaman
    user.script =
    user.variant =

openjdk version "17.0.10" 2024-01-16 LTS
OpenJDK Runtime Environment (Red_Hat-17.0.10.0+7-2) (build 17.0.10+7-LTS)
OpenJDK 64-Bit Server VM (Red_Hat-17.0.10.0+7-2) (build 17.0.10+7-LTS, mixed mode, sharing)

C:\Users\colaman>
```


### 2.2 ë„¤í‹° í´ë¼ì´ì–¸íŠ¸/ì„œë²„ ê°œìš”

```
ê¸°ë³¸ í…œí”Œë¦¿ì€ STS ì˜ springboot ë¡œ ë§Œë“ ë‹¤.
ê¸°ë³¸ maven í”„ë¡œì íŠ¸ì˜ ê²½ìš° ì±„ìš¸ê²Œ ë§ì•„, spring starter project ë¡œ í•œë‹¤.


mvnrepository ì—ì„œ netty ë¥¼ ì°¾ì•„ pom.xml ì— ì¶”ê°€í•œë‹¤.

		<!-- https://mvnrepository.com/artifact/io.netty/netty-all -->
		<dependency>
			<groupId>io.netty</groupId>
			<artifactId>netty-all</artifactId>
			<version>4.1.108.Final</version>
		</dependency>
```


##### ì˜ˆì œíŒŒì¼ì— main í•¨ìˆ˜ê°€ ìˆì–´ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì—°ê²°í•œë‹¤.
```
package com.colamanlabs.nettyinaction.chapter02;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;

import com.colamanlabs.nettyinaction.chapter02.echoserver.EchoServer;

import lombok.extern.slf4j.Slf4j;

@SpringBootApplication
@Slf4j
public class Chapter02ServerApplication
{
    
    public static void main(String[] args)
    {
        SpringApplication.run(Chapter02ServerApplication.class, args);
    }
    
    @EventListener(ApplicationReadyEvent.class)
    public void init() throws Exception
    {
        log.info(String.format("[Chapter02ServerApplication/init] BEGIN"));
        
        EchoServer.main(new String[] { "10000" });
        log.info(String.format("[Chapter02ServerApplication/init] END"));
    }
}
```


##### 2.3.1 ChannelHandler ì™€ ë¹„ì¦ˆë‹ˆìŠ¤ë…¼ë¦¬

```
package com.colamanlabs.nettyinaction.chapter02.echoserver;
import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelFutureListener;
import io.netty.channel.ChannelHandler.Sharable;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;
import io.netty.util.CharsetUtil;

/**
 * Listing 2.1 EchoServerHandler
 *
 * @author <a href="mailto:norman.maurer@gmail.com">Norman Maurer</a>
 */
@Sharable
/*
 * @Sharable 
- ChannelHandlerë¥¼ ì—¬ëŸ¬ ì±„ë„ê°„ì— ì•ˆì „í•˜ê²Œ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒ.
 */
public class EchoServerHandler extends ChannelInboundHandlerAdapter {
    @Override
    public void channelRead(ChannelHandlerContext ctx, Object msg) {
        ByteBuf in = (ByteBuf) msg;
        System.out.println(
                "Server received: " + in.toString(CharsetUtil.UTF_8));
        ctx.write(in);
    }

    @Override
    public void channelReadComplete(ChannelHandlerContext ctx)
            throws Exception {
        ctx.writeAndFlush(Unpooled.EMPTY_BUFFER)
                .addListener(ChannelFutureListener.CLOSE);
    }

    @Override
    public void exceptionCaught(ChannelHandlerContext ctx,
        Throwable cause) {
        cause.printStackTrace();
        ctx.close();
    }
}


```


https://netty.io/4.1/api/io/netty/buffer/Unpooled.html

https://netty.io/4.0/api/io/netty/channel/ChannelFutureListener.html


#### 2.3.2 ì„œë²„ ë¶€íŠ¸ìŠ¤íŠ¸ë©

```
package com.colamanlabs.nettyinaction.chapter02.echoserver;
import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioServerSocketChannel;

import java.net.InetSocketAddress;

/**
 * Listing 2.2 EchoServer class
 *
 * @author <a href="mailto:norman.maurer@gmail.com">Norman Maurer</a>
 */
public class EchoServer {
    private final int port;

    public EchoServer(int port) {
        this.port = port;
    }

    public static void main(String[] args)
        throws Exception {
        if (args.length != 1) {
            System.err.println("Usage: " + EchoServer.class.getSimpleName() +
                " <port>"
            );
            return;
        }
        int port = Integer.parseInt(args[0]);
        new EchoServer(port).start();
    }

    public void start() throws Exception {
        final EchoServerHandler serverHandler = new EchoServerHandler();
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            ServerBootstrap b = new ServerBootstrap();
            b.group(group)
                .channel(NioServerSocketChannel.class)
                .localAddress(new InetSocketAddress(port))
                .childHandler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    public void initChannel(SocketChannel ch) throws Exception {
                        
                        /*
                         * EchoServerHandler ëŠ” @Sharable ì´ë¯€ë¡œ, ë™ì¼í•œ í•­ëª©ì„ ì´ìš©í•  ìˆ˜ ìˆìŒ
                         */
                        ch.pipeline().addLast(serverHandler);
                    }
                });

            
            /*
             * ì„œë²„ë¥¼ ë¹„ë™ê¸°ì‹ìœ¼ë¡œ ë°”ì¸ë”©, sync() ëŠ” ë°”ì¸ë”©ì´ ì™„ë£Œë˜ê¸°ë¥¼ ëŒ€ê¸°
             */
            ChannelFuture f = b.bind().sync();
            System.out.println(EchoServer.class.getName() +
                " started and listening for connections on " + f.channel().localAddress());
            
            /*
             * ì±„ë„ì˜ CloseFuture ë¥¼ ì–»ê³  ì™„ë£Œë  ë•Œ ê¹Œì§€ í˜„ì¬ ìŠ¤ë ˆë“œë¥¼ ë¸”ë¡œí‚¹
             */
            f.channel().closeFuture().sync();
        } finally {
            /*
             * EventLoopGroup ì„ ì¢…ë£Œí•˜ê³ , ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ í•´ì œ
             */
            group.shutdownGracefully().sync();
        }
    }
}


```

```
@Sharable 
- ChannelHandlerë¥¼ ì—¬ëŸ¬ ì±„ë„ê°„ì— ì•ˆì „í•˜ê²Œ ê³µìœ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ê²ƒ.

io.netty.channel
Annotation Type ChannelHandler.Sharable

@Inherited
 @Documented
 @Target(value=TYPE)
 @Retention(value=RUNTIME)
public static @interface ChannelHandler.Sharable
Indicates that the same instance of the annotated ChannelHandler can be added to one or more ChannelPipelines multiple times without a race condition.
If this annotation is not specified, you have to create a new handler instance every time you add it to a pipeline because it has unshared state such as member variables.

This annotation is provided for documentation purpose, just like the JCIP annotations.
```

https://netty.io/4.0/api/io/netty/channel/ChannelHandler.Sharable.html





### 2.4 Echo í´ë¼ì´ì–¸íŠ¸ ë§Œë“¤ê¸°

#### 2.4.1 ChannelHandler ë¥¼ ì´ìš©í•œ í´ë¼ì´ì–¸íŠ¸ ë…¼ë¦¬ êµ¬í˜„
```
package com.colamanlabs.nettyinaction.chapter02.client;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.ChannelHandler.Sharable;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.util.CharsetUtil;

/**
 * Listing 2.3 ChannelHandler for the client
 *
 * @author <a href="mailto:norman.maurer@gmail.com">Norman Maurer</a>
 */
@Sharable
/*
 * ì´ í´ë˜ìŠ¤ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì—¬ëŸ¬ ì±„ë„ì—ì„œ ê³µìœ í•  ìˆ˜ ìˆìŒì„ ë‚˜íƒ€ëƒ„
 */
public class EchoClientHandler extends SimpleChannelInboundHandler<ByteBuf>
{
    
    @Override
    /*
     * ì²´ë„ í™œì„±í™” ì•Œë¦¼ì„ ë°›ìœ¼ë©´ ë©”ì„¸ì§€ë¥¼ ì „ì†¡
     */
    public void channelActive(ChannelHandlerContext ctx)
    {
        ctx.writeAndFlush(Unpooled.copiedBuffer("Netty rocks!", CharsetUtil.UTF_8));
    }
    
    @Override
    public void channelRead0(ChannelHandlerContext ctx, ByteBuf in)
    {
        System.out.println("Client received: " + in.toString(CharsetUtil.UTF_8));
    }
    
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
    {
        cause.printStackTrace();
        ctx.close();
    }
}
```

```
channelRead0() ë©”ì†Œë“œ ì¬ì •ì˜ ë° ì£¼ì˜ì‚¬í•­

ì£¼ì˜í•  ì ì€ ì„œë²„ê°€ ì „ì†¡í•œ ë©”ì„¸ì§€ê°€ ì—¬ëŸ¬ ì²­í¬ë¡œ ìˆ˜ì‹ ë  ìˆ˜ ìˆë‹¤ëŠ” ì ì´ë‹¤. ì¦‰ ì„œë²„ê°€ 5 ë°”ì´íŠ¸ë¥¼ ì „ì†¡í•  ë•Œ 5 ë°”ì´íŠ¸ê°€ ëª¨ë‘ í•œë²ˆì— ìˆ˜ì‹ ëœë‹¤ëŠ” ë³´ì¥ì´ ì—†ë‹¤. ë°ì´í„°ê°€ ì´ë ‡ê²Œ ì ì€ ê²½ìš°ì—ë„ channelRead0() ë©”ì†Œë“œê°€ ë‘ë²ˆ í˜¸ì¶œ ë  ìˆ˜ ìˆë‹¤.

ì¦‰, 3 ë°”ì´íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” ButeBuf í•˜ë‚˜ì™€ 2 ë°”ì´íŠ¸ë¥¼ ì €ì¥í•˜ëŠ” ByteBuf í•˜ë‚˜ë¡œ í•œë²ˆì”©, ë‘ë²ˆ í˜¸ì¶œ ë  ìˆ˜ ìˆë‹¤.

ë‹¤ë§Œ, TCP ëŠ” ìŠ¤íŠ¸ë¦¼ ê¸°ë°˜ í”„ë¡œí† ì½œì´ë¯€ë¡œ, ì„œë²„ê°€ ë³´ë‚¸ ìˆœì„œëŒ€ë¡œ ë°”ì´íŠ¸ë¥¼ ìˆ˜ì‹ í•  ìˆ˜ ìˆê²Œ ë³´ì¥í•œë‹¤.
```




#### 2.4.2 í´ë¼ì´ì–¸íŠ¸ ë¶€íŠ¸ìŠ¤íŠ¸ë©

```
package com.colamanlabs.nettyinaction.chapter02.client;

import io.netty.bootstrap.Bootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.SocketChannel;
import io.netty.channel.socket.nio.NioSocketChannel;

import java.net.InetSocketAddress;

/**
 * Listing 2.4 Main class for the client
 *
 * @author <a href="mailto:norman.maurer@gmail.com">Norman Maurer</a>
 */
public class EchoClient {
    private final String host;
    private final int port;

    public EchoClient(String host, int port) {
        this.host = host;
        this.port = port;
    }

    public void start()
        throws Exception {
        EventLoopGroup group = new NioEventLoopGroup();
        try {
            Bootstrap b = new Bootstrap();
            b.group(group)
                .channel(NioSocketChannel.class)
                .remoteAddress(new InetSocketAddress(host, port))
                .handler(new ChannelInitializer<SocketChannel>() {
                    @Override
                    public void initChannel(SocketChannel ch)
                        throws Exception {
                        ch.pipeline().addLast(
                             new EchoClientHandler());
                    }
                });
            
            /*
             * ì›ê²© í”¼ì–´ë¡œ ì—°ê²°í•˜ê³ , ì—°ê²°ì´ ì™„ë£Œë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦¼ 
             */
            ChannelFuture f = b.connect().sync();
            
            /*
             * ì±„ë„ì´ ë‹«í ë•Œê¹Œì§€ ë¸”ë¡œí‚¹í•¨
             */
            f.channel().closeFuture().sync();
        } finally {
            group.shutdownGracefully().sync();
        }
    }

    public static void main(String[] args)
            throws Exception {
        if (args.length != 2) {
            System.err.println("Usage: " + EchoClient.class.getSimpleName() +
                    " <host> <port>"
            );
            return;
        }

        final String host = args[0];
        final int port = Integer.parseInt(args[1]);
        new EchoClient(host, port).start();
    }
}
```

```
package com.colamanlabs.nettyinaction.chapter02;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;

import com.colamanlabs.nettyinaction.chapter02.client.EchoClient;

import lombok.extern.slf4j.Slf4j;

@SpringBootApplication
@Slf4j
public class Chapter02ClientApplication
{
    
    public static void main(String[] args)
    {
        SpringApplication.run(Chapter02ClientApplication.class, args);
    }
    
    @EventListener(ApplicationReadyEvent.class)
    public void init() throws Exception
    {
        log.info(String.format("[Chapter02ClientApplication/init] BEGIN"));
        EchoClient.main(new String[] { "127.0.0.1", "10000" });
        log.info(String.format("[Chapter02ClientApplication/init] END"));
    }
}
```

##### ì„œë²„ ë¡œê·¸
```
2024-04-10T14:33:04.796+09:00[0;39m [32m INFO[0;39m [35m17832[0;39m [2m---[0;39m [2m[chapter02_server] [  restartedMain][0;39m [2m[0;39m[36mc.c.n.c.Chapter02ServerApplication      [0;39m [2m:[0;39m [Chapter02ServerApplication/init] BEGIN
com.colamanlabs.nettyinaction.chapter02.echoserver.EchoServer started and listening for connections on /[0:0:0:0:0:0:0:0]:10000
Server received: Netty rocks!
```

##### í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸
```
[2m2024-04-10T14:34:11.584+09:00[0;39m [32m INFO[0;39m [35m8936[0;39m [2m---[0;39m [2m[chapter02_client] [  restartedMain][0;39m [2m[0;39m[36mc.c.n.c.Chapter02ClientApplication      [0;39m [2m:[0;39m [Chapter02ClientApplication/init] BEGIN
Client received: Netty rocks!
[2m2024-04-10T14:34:13.904+09:00[0;39m [32m INFO[0;39m [35m8936[0;39m [2m---[0;39m [2m[chapter02_client] [  restartedMain][0;39m [2m[0;39m[36mc.c.n.c.Chapter02ClientApplication      [0;39m [2m:[0;39m [Chapter02ClientApplication/init] END
```


### -- ë --
